@if (platformService.isHybrid()) {
  <ion-header [translucent]="true">
    <ion-toolbar>
      <ion-title>Explore</ion-title>
    </ion-toolbar>
  </ion-header>
}

<ion-content>
  <!-- Full Screen Search Overlay -->
  <div class="search-overlay" [class.active]="isSearchActive" [class.has-header]="platformService.isHybrid()">
    <ion-grid class="search-container">
      <ion-row class="ion-no-padding">
        <ion-col class="ion-no-padding">
          <ion-searchbar
            #searchBar
            class="ion-padding"
            placeholder="Search for an anime, manga, character..."
            animated
            color="light"
            [value]="searchQuery"
            (ionInput)="onSearchInput($event)"
            (ionFocus)="activateSearch()"
            (ionCancel)="deactivateSearch()"
            (keydown.enter)="onEnterPress()"
            (keydown.escape)="deactivateSearch()"
            [showCancelButton]="'always'"
          ></ion-searchbar>
        </ion-col>
      </ion-row>

      <ion-row class="filter-chips-container">
        <ion-row>
          <ion-col>
            <ion-chip
              [outline]="category !== 'anime'"
              color="primary"
              class="filter-chip ion-color-secondary"
              [class.active]="category === 'anime'"
              (click)="changeCategory('anime')"
              >
              <ion-icon class="ion-no-margin ion-margin-end" name="checkmark" />
              Anime
            </ion-chip>
          </ion-col>
          <ion-col>
            <ion-chip
              [outline]="category !== 'manga'"
              color="primary"
              class="filter-chip ion-color-secondary"
              [class.active]="category === 'manga'"
              (click)="changeCategory('manga')"
              >
              <ion-icon class="ion-no-margin ion-margin-end" name="checkmark" />
              Manga
            </ion-chip>
          </ion-col>
          <ion-col>
            <ion-chip
              [outline]="category !== 'characters'"
              color="primary"
              class="filter-chip ion-color-secondary"
              [class.active]="category === 'characters'"
              (click)="changeCategory('characters')"
              >
              <ion-icon class="ion-no-margin ion-margin-end" name="checkmark" />
              Characters
            </ion-chip>
          </ion-col>
        </ion-row>
      </ion-row>

      <ion-row class="search-results">
        @if (searchQuery.length === 0 && results.length === 0) {
          <ion-col class="empty-state">
            <ion-icon name="search-outline"></ion-icon>
            <p>Start typing to search</p>
            <p class="hint">Type at least 3 characters and press Enter</p>
          </ion-col>
        } @else if (searchQuery.length < 3 && results.length === 0) {
          <ion-col class="empty-state">
            <ion-icon name="text-outline"></ion-icon>
            <p>Type at least {{ 3 - searchQuery.length }} more character{{ (3 - searchQuery.length) > 1 ? 's' : '' }}</p>
          </ion-col>
        } @else if (isSearching) {
          <ion-col class="empty-state">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Searching...</p>
          </ion-col>
        } @else if (results.length === 0) {
          <ion-col class="empty-state">
            <ion-icon name="ban-outline"></ion-icon>
            <p>No results found</p>
            <p class="hint">Try a different search term</p>
          </ion-col>
        } @else {
          <!-- Search results will appear here -->
          <ion-col size="12" class="results-wrapper">
            <ion-card-subtitle class="results-info">Searching for "{{ storedQuery }}"</ion-card-subtitle>
            <div class="results-content-wrapper">
              <ion-content #resultsContent class="results-content">
                <ion-grid>
                  <ion-row class="ion-padding-bottom">
                    <!-- Add your search results items here -->
                    @for (result of results; track result.id) {
                      @if (category === 'anime' || category === 'manga') {
                        <ion-col size="12" sizeMd="6" sizeLg="4">
                          <app-media-list-item
                            [media]="result"
                            [isFavourite]="result.isFavourite"
                            (click)="goToDetails({id: result.id, type: result.type, isAdult: result.isAdult})"
                            />
                        </ion-col>
                      } @else if (category === 'characters') {
                        <ion-col size="4" sizeMd="2" sizeLg="1">
                          <app-person-item
                            [name]="result.name.full ?? result.name.native"
                            [image]="result.image.large?.replace('medium', 'large') ?? result.image.medium"
                            [fallbackImage]="result.image.large"
                            (click)="openModal('character', result.id)"
                            />
                          </ion-col>
                      }
                    }
                  </ion-row>
                </ion-grid>
                <ion-infinite-scroll
                  threshold="0px"
                  (ionInfinite)="onIonInfinite($event)"
                  >
                  <ion-infinite-scroll-content loadingSpinner="bubbles"/>
                </ion-infinite-scroll>
              </ion-content>
            </div>
          </ion-col>
        }
      </ion-row>
    </ion-grid>
  </div>

  <!-- QUICK ACCESS OPTIONS -->
  <ion-grid>
    <ion-row>
      <ion-col class="ion-no-padding">
        <div class="searchbar-trigger" (click)="activateSearch()">
          <ion-searchbar
            placeholder="Search for an anime, manga, character..."
            animated
            color="light"
            readonly
          ></ion-searchbar>
        </div>
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col>
        <ion-title>Anime</ion-title>
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="star"
          info="Top 100"
          type="text"
          (click)="navigate('anime/top-100')"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="stats-chart"
          info="Top Popular"
          type="text"
          (click)="navigate('anime/top-popular')"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="time"
          info="Upcoming"
          type="text"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="radio"
          info="Airing"
          type="text"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="flower"
          info="Spring"
          type="text"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="sunny"
          info="Summer"
          type="text"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="rainy"
          info="Fall"
          type="text"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="snow"
          info="Winter"
          type="text"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6">
        <app-info-chip
          icon="film"
          info="Top Movies"
          type="text"
          (click)="navigate('anime/top-movies')"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6">
        <app-info-chip
          icon="calendar"
          info="Calendar"
          type="text"
          (click)="navigate('calendar')"
          clickable
        />
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col>
        <ion-title>Manga</ion-title>
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="star"
          info="Top 100"
          type="text"
          (click)="navigate('manga/top-100')"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="stats-chart"
          info="Top Popular"
          type="text"
          (click)="navigate('manga/top-popular')"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="time"
          info="Upcoming"
          type="text"
          clickable
        />
      </ion-col>
      <ion-col sizeXs="6" sizeMd="3">
        <app-info-chip
          icon="radio"
          info="Publishing"
          type="text"
          clickable
        />
      </ion-col>
    </ion-row>
  </ion-grid>

  <ion-modal [isOpen]="isModalOpen" (willDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button
              class="closeModalButton"
              (click)="closeModal()"
              >
              <ion-icon name="arrow-back" />
            </ion-button>
          </ion-buttons>

          <ion-buttons slot="end">
            <ion-button (click)="toggleCharacterFavorite()" [disabled]="isTogglingFavorite">
              @if (isTogglingFavorite) {
                <ion-spinner name="dots" slot="icon-only"></ion-spinner>
              } @else {
                <ion-icon
                  slot="icon-only"
                  [name]="modalData?.isFavourite ? 'heart' : 'heart-outline'"
                  [color]="modalData?.isFavourite ? 'danger' : 'medium'">
                </ion-icon>
              }
            </ion-button>

            <ion-button>
              <ion-icon slot="icon-only" name="share-social"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
        <ion-toolbar>
          <ion-grid>
            <ion-row>
              <ion-col>
                <ion-segment
                  [value]="modalSelectedTab"
                  (ionChange)="onSegmentChange($event)"
                  mode="md"
                  class="tab-segment">

                  <ion-segment-button value="info" layout="icon-top">
                    <ion-icon name="information-circle"></ion-icon>
                  </ion-segment-button>

                  <ion-segment-button value="media" layout="icon-top">
                    <ion-icon name="film"></ion-icon>
                  </ion-segment-button>

                  <!-- @if (modalData?.voiceActingRoles) {
                    <ion-segment-button value="va" layout="icon-top">
                      <ion-icon name="mic"></ion-icon>
                    </ion-segment-button>
                  } -->
                </ion-segment>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-no-padding">
        <ion-grid>
          <ion-row class="tabsContainer">
            @if (!modalDataLoading) {
              @switch (modalSelectedTab) {
                @case ('info') {
                  <app-people-info-tab [data]="modalData" [loading]="modalDataLoading" />
                }
                @case ('media') {
                  <app-people-media-tab [data]="modalData" (navigate)="goToDetails($event)" />
                }
                @case ('va') {
                  <app-people-va-tab [data]="modalData" [loading]="modalDataLoading" />
                }
              }
            } <!-- @else {
              <ion-col>
                @for (i of 7 | range; track i) {
                  <ion-row>
                    <ion-col size="12">
                      <ion-skeleton-text class="skeleton" animated/>
                    </ion-col>
                  </ion-row>
                }
              </ion-col>
            } -->
          </ion-row>
        </ion-grid>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
