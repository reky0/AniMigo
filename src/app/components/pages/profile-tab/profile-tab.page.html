@if (platformService.isHybrid()) {
  <ion-header [translucent]="true">
    <ion-toolbar>
      <ion-title>Profile</ion-title>
    </ion-toolbar>
  </ion-header>
}

<ion-content [fullscreen]="false">
  @if (!isAuthenticated) {
    <am-login-prompt (loginClick)="login()"></am-login-prompt>
  } @else {
    <!-- Profile Banner -->
    <div class="profile-banner">
      @if (loading) {
        <ion-skeleton-text animated />
      } @else {
        <div class="banner-image" [style.background-image]="'url(' + userBanner + ')'"></div>
        <div class="banner-overlay"></div>
      }
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
      <ion-grid class="ion-no-padding">
        <ion-row>
          <ion-col size="12">
            <!-- Avatar -->
            <ion-row class="avatar-container">
              <ion-col size="4" sizeMd="0" />

              <ion-col size="4" sizeMd="2">
                @if (userAvatar) {
                  <ion-avatar class="profile-avatar">
                    <img [src]="userAvatar" [alt]="username + ' Avatar'" />
                  </ion-avatar>
                } @else {
                  <ion-skeleton-text animated class="profile-avatar" />
                }
              </ion-col>

              <ion-col size="2" sizeMd="8" />

              <!-- Action Buttons -->
              <ion-col size="2" class="profile-actions">
                <ion-buttons>
                  <ion-button
                    (click)="goToSettings()">
                    <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
                  </ion-button>
                </ion-buttons>
              </ion-col>
            </ion-row>

            <!-- User Info -->
            <ion-row class="user-info">
              <ion-col size="12" sizeMd="6">
                <ion-title class="username ion-no-padding">{{ username }}</ion-title>
              </ion-col>
              <ion-col size="12" sizeMd="6" class="user-meta">
                <ion-card-subtitle class="meta-item">
                  <ion-icon name="calendar-outline"></ion-icon>
                  {{ joinDate }}
                </ion-card-subtitle>
              </ion-col>
              <ion-col size="12">
                <ion-card-subtitle class="user-bio">{{ userBio }}</ion-card-subtitle>
              </ion-col>
            </ion-row>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Stats Section -->
    <div class="stats-section">
      <ion-grid>
        <ion-row>
          <ion-col size="12">
            @if (loading && !userData) {
              <ion-skeleton-text animated class="skeleton" />
            } @else {
              <ion-card class="stats-card">
                <ion-card-content>
                  @if (totalAnime !== 0 || totalManga !== 0 || watchTime !== '0d 0h' || chaptersRead !== 0) {
                    <ion-grid class="ion-no-padding">
                      <ion-row>
                        <ion-col size="6" sizeMd="3">
                          <div class="stat-item">
                            <div class="stat-value">{{ totalAnime }}</div>
                            <div class="stat-label">Total Anime</div>
                          </div>
                        </ion-col>
                        <ion-col size="6" sizeMd="3">
                          <div class="stat-item">
                            <div class="stat-value">{{ watchTime }}</div>
                            <div class="stat-label">Watch Time</div>
                          </div>
                        </ion-col>
                        <ion-col size="6" sizeMd="3">
                          <div class="stat-item">
                            <div class="stat-value">{{ totalManga }}</div>
                            <div class="stat-label">Total Manga</div>
                          </div>
                        </ion-col>
                        <ion-col size="6" sizeMd="3">
                          <div class="stat-item">
                            <div class="stat-value">{{ chaptersRead }}</div>
                            <div class="stat-label">Chapters Read</div>
                          </div>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  } @else {
                    <p class="empty-state">No statistics available. @if (isAuthenticated) { <br> Most stats refresh after 24h. }</p>
                  }
                </ion-card-content>
              </ion-card>
            }
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Profile Content -->
    <div class="profile-content">
      <ion-grid>
        <ion-row>
          <!-- Left Column - Main Content -->
          <ion-col size="12" sizeLg="8">

            <!-- Favorites Section -->
            <div class="content-section">
              <div class="section-header">
                <h2>Favorite Anime</h2>
                @if (isAuthenticated) {
                  <ion-button fill="clear" size="small" (click)="openFavouritesModal('anime')">
                    View All
                    <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
                  </ion-button>
                }
              </div>

              @if (loading && !userData) {
                <ion-skeleton-text animated class="skeleton" />
              } @else if (favoriteAnime.length > 0) {
                <ion-grid class="favorites-grid ion-margin-bottom">
                  <ion-row>
                    @for (i of (isDesktop() ? 9 : 6) | range; track $index) {
                      @if (favoriteAnime[i-1]) {
                        <ion-col size="4" sizeMd="2" sizeLg="1.3333">
                          <am-catalog-item
                            [title]="favoriteAnime[i-1].title.english || favoriteAnime[i-1].title.romaji"
                            [image]="favoriteAnime[i-1].coverImage.large?.replace('medium', 'large') ?? favoriteAnime[i-1].coverImage.medium"
                            [fallbackImage]="favoriteAnime[i-1].coverImage.large"
                            [mediaStatus]="favoriteAnime[i-1].mediaListEntry?.status"
                            (click)="goToDetails({id: favoriteAnime[i-1].id, type: favoriteAnime[i-1].type, isAdult: favoriteAnime[i-1].isAdult})"
                            />
                        </ion-col>
                      }
                    }
                  </ion-row>
                </ion-grid>
              } @else {
                <ion-card>
                  <ion-card-content>
                    <p class="empty-state">No favorite animes yet. @if (isAuthenticated) { <br> Add favorites on <a href="https://anilist.co/" target="_blank">AniList!</a> }</p>
                  </ion-card-content>
                </ion-card>
              }

              <div class="section-header">
                <h2>Favorite Manga</h2>
                @if (isAuthenticated) {
                  <ion-button fill="clear" size="small" (click)="openFavouritesModal('manga')">
                    View All
                    <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
                  </ion-button>
                }
              </div>

              @if (loading && !userData) {
                <ion-skeleton-text animated class="skeleton" />
              } @else if (favoriteManga.length > 0) {
                <ion-grid class="favorites-grid ion-margin-bottom">
                  <ion-row>
                    @for (i of (isDesktop() ? 9 : 6) | range; track $index) {
                      @if (favoriteManga[i-1]) {
                        <ion-col size="4" sizeMd="2" sizeLg="1.3333">
                          <am-catalog-item
                            [title]="favoriteManga[i-1].title.english || favoriteManga[i-1].title.romaji"
                            [image]="favoriteManga[i-1].coverImage.large?.replace('medium', 'large') ?? favoriteManga[i-1].coverImage.medium"
                            [fallbackImage]="favoriteManga[i-1].coverImage.large"
                            [mediaStatus]="favoriteManga[i-1].mediaListEntry?.status"
                            (click)="goToDetails({id: favoriteManga[i-1].id, type: favoriteManga[i-1].type, isAdult: favoriteManga[i-1].isAdult})"
                            />
                        </ion-col>
                      }
                    }
                  </ion-row>
                </ion-grid>
              } @else {
                <ion-card>
                  <ion-card-content>
                    <p class="empty-state">No favorite mangas yet. @if (isAuthenticated) { <br> Add favorites on <a href="https://anilist.co/" target="_blank">AniList!</a> }</p>
                  </ion-card-content>
                </ion-card>
              }

              <div class="section-header">
                <h2>Favorite Characters</h2>
                @if (isAuthenticated) {
                  <ion-button fill="clear" size="small" (click)="openFavouritesModal('characters')">
                    View All
                    <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
                  </ion-button>
                }
              </div>

              @if (loading && !userData) {
                <ion-skeleton-text animated class="skeleton" />
              } @else if (favoriteCharacters.length > 0) {
                <ion-grid class="favorites-grid">
                  <ion-row>
                    @for (i of (isDesktop() ? 9 : 6) | range; track $index) {
                      @if (favoriteCharacters[i-1]) {
                        <ion-col size="4" sizeMd="2" sizeLg="1.3333">
                          <am-character-item
                            [name]="favoriteCharacters[i-1].name.full"
                            [image]="favoriteCharacters[i-1].image.large?.replace('medium', 'large') ?? favoriteCharacters[i-1].image.medium"
                            [fallbackImage]="favoriteCharacters[i-1].image.large"
                            (click)="openModal('character', favoriteCharacters[i-1].id)"
                            />
                        </ion-col>
                      }
                    }
                  </ion-row>
                </ion-grid>
              } @else {
                <ion-card>
                  <ion-card-content>
                    <p class="empty-state">No favorite characters yet. @if (isAuthenticated) { <br> Add favorites on <a href="https://anilist.co/" target="_blank">AniList!</a> }</p>
                  </ion-card-content>
                </ion-card>
              }
            </div>

            <!-- Genre Distribution -->
            <div class="content-section">
              <div class="section-header">
                <h2>Genre Overview</h2>
              </div>

              @if (loading && !userData) {
                <ion-skeleton-text animated class="skeleton" />
              } @else if (topGenres.length > 0) {
                <ion-card class="genre-card">
                  <ion-card-content>
                    <div class="genre-item" *ngFor="let genreData of topGenres">
                      <div class="genre-info">
                        <span class="genre-name">{{ genreData.genre }}</span>
                        <span class="genre-count">{{ genreData.count }}</span>
                      </div>
                      <ion-progress-bar [value]="genreData.count / totalAnime" color="primary"></ion-progress-bar>
                    </div>
                  </ion-card-content>
                </ion-card>
              } @else {
                <p class="empty-state">No genre data available</p>
              }
            </div>
          </ion-col>

          <!-- Right Column - Sidebar -->
          <ion-col size="12" sizeLg="4">
            <!-- Watch List Stats -->
            <am-media-status-stats
              title="Anime List"
              mediaType="ANIME"
              [statusCounts]="animeStatusCountsForComponent"
            />

            <am-media-status-stats
              title="Manga List"
              mediaType="MANGA"
              [statusCounts]="mangaStatusCountsForComponent"
            />
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>
  }

  <ion-modal [isOpen]="modalState.isOpen" (willDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button
              class="closeModalButton"
              (click)="closeModal()"
              >
              <ion-icon name="arrow-back" />
            </ion-button>
          </ion-buttons>

          <ion-buttons slot="end">
            <ion-button (click)="toggleCharacterFavorite()" [disabled]="modalState.isTogglingFavorite">
              @if (modalState.isTogglingFavorite) {
                <ion-spinner name="dots" slot="icon-only"></ion-spinner>
              } @else {
                <ion-icon
                  slot="icon-only"
                  [name]="modalState.data?.isFavourite ? 'heart' : 'heart-outline'"
                  [color]="modalState.data?.isFavourite ? 'danger' : 'medium'">
                </ion-icon>
              }
            </ion-button>

            <ion-button>
              <ion-icon slot="icon-only" name="share-social"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
        <ion-toolbar>
          <ion-grid>
            <ion-row>
              <ion-col>
                <ion-segment
                  [value]="modalState.selectedTab"
                  (ionChange)="onSegmentChange($event)"
                  mode="md"
                  class="tab-segment">

                  <ion-segment-button value="info" layout="icon-top">
                    <ion-icon name="information-circle"></ion-icon>
                  </ion-segment-button>

                  <ion-segment-button value="media" layout="icon-top">
                    <ion-icon name="film"></ion-icon>
                  </ion-segment-button>

                  <!-- @if (modalState.data?.voiceActingRoles) {
                    <ion-segment-button value="va" layout="icon-top">
                      <ion-icon name="mic"></ion-icon>
                    </ion-segment-button>
                  } -->
                </ion-segment>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-no-padding">
        <ion-grid>
          <ion-row class="tabsContainer">
            @if (!loading) {
              @switch (modalState.selectedTab) {
                @case ('info') {
                  <am-people-info-tab [data]="modalState.data" [loading]="loading" />
                }
                @case ('media') {
                  <am-people-media-tab [data]="modalState.data" (navigate)="goToDetails($event)" />
                }
                @case ('va') {
                  <am-people-va-tab [data]="modalState.data" (navigate)="goToDetails($event)" />
                }
              }
            } <!-- @else {
              <ion-col>
                @for (i of 7 | range; track i) {
                  <ion-row>
                    <ion-col size="12">
                      <ion-skeleton-text class="skeleton" animated/>
                    </ion-col>
                  </ion-row>
                }
              </ion-col>
            } -->
          </ion-row>
        </ion-grid>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="modalState.isFavouritesOpen" (willDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button
              class="closeModalButton"
              (click)="closeModal()"
              >
              <ion-icon name="arrow-back" />
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-no-padding">
        <ion-grid>
          <ion-row>
            @if (!loading) {
              @switch (modalState.favouriteType) {
                @case ('anime') {
                  @for (anime of favoriteAnime; track $index) {
                    <ion-col size="12" sizeMd="6">
                      <am-media-list-item
                        [title]="anime.title.english ?? anime.title.romaji"
                        [media]="anime"
                        (click)="goToDetails({id: anime.id, type: anime.type, isAdult: anime.isAdult})"
                        />
                    </ion-col>
                  }
                }
                @case ('manga') {
                  @for (manga of favoriteManga; track $index) {
                    <ion-col size="12" sizeMd="6">
                      <am-media-list-item
                        [title]="manga.title.english ?? manga.title.romaji"
                        [media]="manga"
                        (click)="goToDetails({id: manga.id, type: manga.type, isAdult: manga.isAdult})"
                        />
                    </ion-col>
                  }
                }
                @case ('characters') {
                  @for (character of favoriteCharacters; track $index) {
                    <ion-col size="4" sizeMd="3">
                      <am-character-item
                        [name]="character.name.full"
                        [image]="character.image.large?.replace('medium', 'large') ?? character.image.medium"
                        [fallbackImage]="character.image.large"
                        (click)="openModal('character', character.id)"
                        />
                    </ion-col>
                  }
                }
              }
            }
          </ion-row>
        </ion-grid>
        <ion-infinite-scroll
          (ionInfinite)="loadMoreFavourites($event)"
          [disabled]="!favouritesPagination[modalState.favouriteType].hasNextPage"
          threshold="20px"
        >
          <ion-infinite-scroll-content loadingSpinner="bubbles"/>
        </ion-infinite-scroll>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>

